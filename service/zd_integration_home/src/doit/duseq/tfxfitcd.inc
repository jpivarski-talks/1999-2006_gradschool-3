*
* $Id: tfxfitcd.inc,v 1.10 2002/09/24 00:31:52 dpp Exp $
*
* $Log: tfxfitcd.inc,v $
* Revision 1.10  2002/09/24 00:31:52  dpp
*      -> change dimension of STZERD from NGRUP to MLTFX
*         filling of STZERD in TFXFIN had overwritten SMLDIF but
*         that's OK since SMLDIF is always filled directly after STZERD
*      -> add MAXEXT, maximum allowed extrapolation width for standard tfxfit
*
* Revision 1.9  2001/11/20 17:56:17  dpp
*      -> use new variable SCALNW for wide road selection of non group layers
*
* Revision 1.8  2001/11/19 23:18:14  dpp
*      -> change SCALEN to be layer dependent
*
* Revision 1.7  2001/09/12 22:09:54  dpp
*      -> deweight when at top of curler
*
* Revision 1.6  2001/04/19 17:21:35  dpp
*      -> more new variables to allow roads that vary with silicon efficiency
*
* Revision 1.5  2001/03/30 00:03:51  dpp
*     -> many new variables to allow roads that vary with silicon efficiency
*
* Revision 1.4  2000/10/02 21:15:04  dpp
*      -> comment
*      -> save SRCFIT in SRCUSE along with FTLUSE
*      -> z test on hits in standard
*      -> label reduced drift distance hits
*      -> deweight reduced drift distance hits
*
* Revision 1.3  2000/05/26 16:54:50  dpp
*      -> expanded tracer info
*      -> some cuts changed to group dependent
*      -> comment
*
* Revision 1.2  2000/04/26 14:26:09  dpp
*      -> add parameters for character string tracer
*      -> add character string tracer
*      -> remove HITDMP
*
* Revision 1.1.1.1  1998/02/06 19:11:49  dpp
* DOIT first release.
*
* Revision 1.1.1.1  1997/04/30 12:31:26  clib
* Developmental version of DUET.
*
* Revision 1.9  1996/07/08 21:48:48  dpp
* switch to allow alternate value of SAMHRD for silicon
*
* Revision 1.8  1996/02/06 00:17:56  zfiles
* allow gaps in strings
*
* Revision 1.7  1996/01/25 15:13:33  zfiles
* increase size of ARGSTR used in diagnostics
*
* Revision 1.6  1995/12/18 19:46:42  nk
* changes to TFXFIT hit selection, updates of TFXFIT graphics
*
* Revision 1.5  1995/09/26  14:56:01  zfiles
* Exceeded 72 columns.
*
* Revision 1.4  1995/09/26  13:52:37  zfiles
* remove compiler switch on common block for ARGSTR
*
* Revision 1.3  1995/09/25  19:30:44  zfiles
* incorporated documentation
* add group status variable that had been local in TFXFIT
*
* Revision 1.2  1995/06/25  01:16:49  zfiles
* Mods from Rob (and Jon)
* doit/duseq/cdtrakcd.inc
* doit/duseq/cdtrakdo.inc
* Add new variable PATLCD.
* doit/duseq/tfxfitcd.inc
*
* Revision 1.1.1.1  1994/10/08  01:01:11  zfiles
* first version of doit in CVS
*
*
*CMZ :  6.00/16 10/03/94  14.15.10  by  Rob Kutschke
*CMZ :  6.00/15 04/03/94  17.45.34  by  Dan Peterson
*CMZ :          22/10/93  18.10.40  by  Dan Peterson
* PARAMETERS AND COMMON FOR TFXFIT CONTROL AND CUTS
*
* tfxfitcd.inc
*
#if !defined(CLEO_NOCOMDOC)

C PARAMETERS

C..NGRUP..........NUMBER OF AMBIGUITY GROUPS
C..MGLAYR.........MAXIMUM NUMBER OF LAYERS IN A GROUP
C..MGSTOR.........MAXIMUM NUMBER OF HITS IN A LAYER
C..TOTLGR.........PRODUCT GROUP*LAYER
C..TOTHGR.........PRODUCT GROUP*LAYER*HIT
C..MLTFX..........MAXIMUM NUMBER OF LAYERS IN TFXFIT
C..MHTFX..........maximum number of hits in TFXFIT
C..MPASS..........Maximum number of passes, dimension
C..NFTMIN.... MINIMUM OF NFIT TO ALLOW CALL TO CFCFIT, OTHERWISE RETURN ERROR
C..M_TRACER_LINES.number of tracer lines for TFXFIT display

C GROUP DEFINITION AND CUTS

C..TFXS...... SWITCH, =1 FOR CF, =2 FOR LF
C..L0TFXF.... "zero" OF LAYERS, conversion to TF layer system

C..LLAYGR.... FIRST TFXFIT LAYER, XLYR,  IN A GROUP
C..NLAYGR.... NUMBER OF TF LAYERS IN A GROUP
C..PASS1G..A. FIRST PASS TO ALLOW USE OF THIS GROUP
C..PASSAG..A. PASS NUMBER TO BEGIN ALWAYS ALLOWING USE OF THIS GROUP
C..SKIPPS.... SKIP PASS; ok to skip this pass if previous had IGNORD=0
C..MPASSA..A. MAXIMUM NUMBER OF PASSES THROUGH LOCAL AMBIGUITY
C..MPASSS..S. MAXIMUM NUMBER OF PASSES THROUGH STANDARD CFXFIT
C..MPASSL..A. MAXIMUM NUMBER OF PASSES selecting other groups
C             with residual difference relative to best
C..
C..SCALEN..S. SCALE TO USE WHEN LAYER IS NOT IN A GROUP
C..SCALNW..S. SCALE TO USE WHEN LAYER IS NOT IN A GROUP, WIDE ROAD

C..HEFSCL..S. HIGH EFFICIENCY SCALE OF RESOLUTION TO DETERMINE ROAD, 
C..ULEFSC..S. LOGICAL: USE LOW EFFICIENCY SCALING 
C..LEFSCL..S. LOW EFFICIENCY SCALE OF RESOLUTION TO DETERMINE ROAD, 
C..LCMPEF..S. LOW EFF SCALE USED BELOW THIS LOW COMPLIMENTARY EFFICIENCY
C..HCMPEF..S. HIGH EFF SCALE USED ABOVE THIS HIGH COMPLIMENTARY EFFICIENCY
C..STANRD..S. STANDARD cfxfit narrow absolute ROAD, fraction of CHISQ cut

C..ILAMRD..A. INITIAL LOCAL AMBIGUITY ROAD, absolute
C..LDRFRD..A. LARGE DRIFTDISTANCE ROAD,  cut, fraction of a full cell
C..DEWRDR..A. DEWEIGHT when using REDUCED DRIFT DISTANCE
C..ISHFRD..A. ISOLATED HIT ROAD when no previous hit(was LUSETF=.FALSE.) 
C             two hits are isolated if separated by this absolute distance
C..ISHTRD..A. ISOLATED HIT ROAD,as ISHFRD but previous hit,(was LUSETF=.TRUE.) 
C..SAMHRD..A. SAME HIT ROAD,  within which two hits are essentially identical
C..LSMHRA..A. LOGICAL, USE ALTERNATE VALUE OF SAMHRD
C..MAXEXT..S. MAXimum EXTrapolation error into layer
C..STZERD..S. STANDARD TFXFIT Z at Endplate absolute ROAD
C..SMLDIF..S. SMALL ABS RESIDUAL DIF;below which is confusing which hit to take
C..LRGDIF..S. LARGE RESIDUAL ABS DIF;above which, do not assign confusing hits
C..DEWCRL.. . DEWEIGHT when hit is at top of CURLER
C..MAXGAP..A. MAXIMUM SINGLE GAP allowed in a string
C..TOTGAP..A. MAXIMUM TOTAL of all GAPS allowed in a string 
C..CHRDHE..A. CORRELATED HITS ROAD, HIGH PRODUCT EFFICIENCY, loc amb, absolute
C..CHRDLE..A. CORRELATED HITS ROAD, LOW PRODUCT EFFICIENCY, loc amb, absolute
C..HPRDEF..A. HIGH PRODUCT EFFICIENCY, above which use CHRDHE
C..LPRDEF..A. LOW PRODUCT EFFICIENCY, below which use CHRDLE
C..BSRSRD..A. BEST STRING RESIDUAL ROAD (for each pass)
C..BSNHMN..A. BEST STRING, NUMBER of HITS MINIMUM, now a variable
C..SRDFL0..A. SIGNIFICANT RESOLUTION DIFFERENCE, LENGTH DIFFERENT BY 0
C..SRDFL1..A. SIGNIFICANT RESOLUTION DIFFERENCE, LENGTH DIFFERENT BY 1
C..OSRDRD..A. OTHER STRING RESIDUAL DIFFERENCE ROAD
C..IGSSLN..A. IGNORED STRING SIGNIFICANT LENGTH; to set IGNORE flag
C..WSRDRD..A. WITHIN STRING RESIDUAL DIFFERENCE ROAD; resid relative to average
C..MULTIH..A. MULTIPLE HITS; add more than one hit per layer only in LOC AMB

C GROUP STATUS

C..EFFTOT.... TOTAL EFFICIENCY OF LAYERS IN THIS GROUP
C..NHITGR ... NUMBER OF HITS IN THIS GROUP/LAYER
C..ILLYRG.... SAVED DUET LOGICAL LAYER OF THIS GROUP/LAYER
C..FTLUSE.... IHIT NUMBER USED IN FIT FOR LUSETF LAYER IN THIS GROUP/LAYER
C..SRCUSE.... PROGRAM_INDICATOR FOR HIT USED IN FIR FOR LUSETF LAYER
C..IHITGR.... SAVED IH (NOT IADRHT(IH)) FOR ELEMENT IN THIS GROUP/LAYER/ELEMENT
C..LFESGR.... LAYER FOR FIRST ELEMENT OF STRING FOR GROUP/LAYER/ELEMENT
C..EFESGR.... ELEMENT FOR FIRST ELEMENT OF STRING FOR GROUP/LAYER/ELEMENT
C..NXLRGR.... NEXT LAYER FOR SAME GROUP/SAME LAYER/THIS ELEMEN
C..NXHTGR.... NEXT ELEMENT(IN NEXT LAYER) FOR SAME GROUP/SAME LAYER/THIS ELEMEN
C..LNHTGR.... NUMBER OF ELEMENTS(LENGTH) FOR THIS STARTING GROUP/FIRST LAYER/EL
C..NGAPGR.... NUMBER OF MISSING LAYERS FOR THIS STARTING GROUP/FIRST LAYER/EL
C..MISHTG.... SIGNED RESIDUAL FOR THIS ELEMENT
C..MISSTG.... SIGNED RESIDUAL FOR THIS STRING OF ELEMENTS
C..REDUCD.... 1     REDUCED DRIFT DISTANCE FOR THIS ELEMENT
C..SAMEAS.... POINTS TO OTHERH IN SAME GROUP,LAYER THAT'S ESSENTIALLY IDENTICAL
C..STRGHT.... POINTS TO STRING OF IDENTICAL OTHERH IN SAME GROUP,LAYER
C..PRIMHT.... POINTS TO THE PRIMARY HIT OF A STRHHT STRING
C..STRMNR.... MINIMUN RESIDUAL OF A STRHHT STRING
C..STRMXR.... MAXIMUN RESIDUAL OF A STRHHT STRING
C..ISOHGR.... ISOLATION: BITS ARE INDEPENDENT, THIS IS RESET AT EACH ITERATION
C        .... 1     ISOLATED  TO THE - SIDE
C        .... 2     ISOLATED  TO THE + SIDE
C        .... 3     BOTH
C        .... 0     NEITHER
C        .... 4     IF IT IS OPEN TO USE AS EARLY PART OF STRINGS
C        .... 8     IF IT IS OPEN TO USE AS LATER PART OF STRINGS
C .. 16, SET, NOT USED, IF OK TO ADD TO FIT LIST, BASED ON ERROR WITHIN GROUP
C        .... 32    NOT LUSETF,OR AT LEAST NOT USING WR0NG HIT OF AN LUSETF
C..LYRUSE.... INTERNAL USE FLAG FOR LAYER, NOT RESET BETWEEN ITERATIONS
C        .... 0     NOT USED..YET; AVAILABLE FOR HIT SELECTION
C        .... 1     DO NOT USE LAYER; HIT HAS BAD RESOLUTION COMPARED TO GROUP
C        .... 2     DO NOT USE LAYER; GROUP HAS GARBAGE CFIND HIT
C        .... 3     FILLED BY REGULAR TFXFIT
C        .... 4     FILLED BY LOCAL AMBIGUITY TFXFIT
C..HITUSE.... INTERNAL USE FLAG FOR HIT, NOT RESET BETWEEN ITERATIONS
C        .... 0     NOT USED..YET; AVAILABLE FOR HIT SELECTION
C        .....1     found filled at entry
C        .... 2     DO NOT USE HIT; HIT HAS BAD RESOLUTION COMPARED TO GROUP
C        .... 3     DO NOT USE HIT; GROUP HAS A WRONG_LUSETF_LAYER_HIT
C        .... 4     FILLED BY REGULAR TFXFIT
C        .... 5     FILLED BY LOCAL AMBIGUITY TFXFIT
C..GRPSTA.... GROUP STATUS,  "BEST" OR "KEEP" OR "JUNK"
C        .... -1    GROUP IS JUNK
C        .... 0     UNKNOWN
C        .... 1     GROUP NOT USED
C        .... 2     GROUP ADDED TO HIT LIST
C        .... 3     THIS IS THE SO CALLED BEST GROUP
C..HITSTA.... HIT STATUS
C        .... 0     NOT ADDED FOR UNKNOWN REASON
C        .... 1     NOT ADDED because it is blocked by LYRUSE
C        .... 2     NOT ADDED BECAUSE THE RESIDUAL IS BAD
C        .... 3     NOT ADDED BECAUSE GROUP CONTAINS A WRONG_LUSETF_LAYER_HIT
C        .... 4     IN FIT ALREADY, BUT IT IS A WRONG_LUSETF_LAYER_HIT
C        .... 5     IN FIT ALREADY, AND IT IS RIGHT LUSETF LAYER HIT
C        .... 6     ADDED

C EXTRA DIAGNOSTIC VARIABLES
C..ARGSTR.... STORE ARGUMENT LIST FOR DIAGNOSTIC ROUTINE
C TRACER......tracer using character string
C TRACER_NUM..stored numbers for each of the tracer lines
C N_TRACER....number of LINES filled in tracer
C N_HIT_TFXF..number of hits in the TFXFIT display
C HIT_DISPLA..hit number for which to display the trace

C23456789 123456789 123456789 123456789 123456789 123456789 123456789 12
#endif


      INTEGER NGRUP,MGLAYR,MGSTOR,TOTLGR,TOTHGR
      PARAMETER (NGRUP=15,MGLAYR=6,MGSTOR=10)
      PARAMETER (TOTLGR=NGRUP*MGLAYR,TOTHGR=TOTLGR*MGSTOR)
      INTEGER MLTFX
      PARAMETER (MLTFX = KLYRDM)
      INTEGER MHTFX
      PARAMETER (MHTFX = NHITDM)
      INTEGER MPASS
      PARAMETER (MPASS=9)
      INTEGER NFTMIN
      PARAMETER (NFTMIN=5)
      INTEGER M_TRACER_LINES
      PARAMETER (M_TRACER_LINES=50)

      INTEGER TFXS  ,L0TFXF
      INTEGER LLAYGR,NLAYGR,PASS1G,PASSAG
      INTEGER SKIPPS
      INTEGER MPASSA,MPASSS,MPASSL
      REAL    SCALEN,SCALNW
      REAL    HEFSCL
      LOGICAL ULEFSC
      REAL    LEFSCL
      REAL    LCMPEF
      REAL    HCMPEF
      REAL    STANRD
      REAL    ILAMRD
      REAL    LDRFRD,DEWRDR
      REAL    ISHFRD,ISHTRD
      REAL    SAMHRD
      LOGICAL LSMHRA
      REAL    MAXEXT,STZERD,SMLDIF,LRGDIF,DEWCRL
      REAL    CHRDHE,CHRDLE,HPRDEF,LPRDEF
      INTEGER MAXGAP,TOTGAP
      REAL    BSRSRD
      INTEGER BSNHMN
      REAL    SRDFL0,SRDFL1
      REAL    OSRDRD
      INTEGER IGSSLN
      REAL    WSRDRD
      LOGICAL MULTIH
      CHARACTER*30 TRACER
      INTEGER TRACER_NUM
      INTEGER N_TRACER
      INTEGER N_HIT_TFXF
      INTEGER HIT_DISPLA

C23456789 123456789 123456789 123456789 123456789 123456789 123456789 12

      COMMON/CITFXF/
     1 TFXS           ,L0TFXF(      2),
     2 LLAYGR(NGRUP,2),NLAYGR(NGRUP,2),PASS1G(NGRUP,2),PASSAG(NGRUP,2),
     3 SKIPPS(10,   2),MPASSA(      2),MPASSS(      2),MPASSL(      2),
     4 MAXGAP(NGRUP,2),TOTGAP(NGRUP,2),BSNHMN(NGRUP,2),IGSSLN(      2)
      COMMON/CRTFXF/
     1 SCALEN(MLTFX,2),SCALNW(MLTFX,2),
     2 HEFSCL(NGRUP,2),LEFSCL(NGRUP,2),LCMPEF(NGRUP,2),HCMPEF(NGRUP,2),
     3 STANRD(      2),
     4 ILAMRD(NGRUP,2),LDRFRD(NGRUP,2),DEWRDR(NGRUP,2),
     5 ISHFRD(NGRUP,2),ISHTRD(NGRUP,2),
     6 SAMHRD(NGRUP,2),MAXEXT(MLTFX,2),STZERD(MLTFX,2),
     7 SMLDIF(MLTFX,2),LRGDIF(MLTFX,2),
     8 DEWCRL(MLTFX,2),
     9 CHRDHE(NGRUP,2),CHRDLE(NGRUP,2),HPRDEF(NGRUP,2),LPRDEF(NGRUP,2),
     x BSRSRD(MPASS,2),
     1 SRDFL0(      2),SRDFL1(      2),
     2 OSRDRD(NGRUP,2),WSRDRD(NGRUP,2)
      COMMON/CLTFXF/
     1 ULEFSC(NGRUP,2),LSMHRA,         MULTIH(NGRUP,2)



      REAL    EFFTOT
      INTEGER NHITGR, ILLYRG, FTLUSE, SRCUSE, IHITGR
      INTEGER LFESGR, EFESGR, NXLRGR, NXHTGR, LNHTGR, NGAPGR
      REAL    MISHTG, MISSTG
      INTEGER REDUCD, SAMEAS, STRGHT, PRIMHT, ISOHGR
      REAL    STRMNR, STRMXR
      INTEGER LYRUSE, HITUSE
      INTEGER GRPSTA, HITSTA


      COMMON/CITFXS/
     1 NHITGR(NGRUP,MGLAYR),       ILLYRG(NGRUP,MGLAYR),
     2 FTLUSE(NGRUP,MGLAYR),
     2 SRCUSE(NGRUP,MGLAYR),
     3 IHITGR(NGRUP,MGLAYR,MGSTOR),LFESGR(NGRUP,MGLAYR,MGSTOR),
     4 EFESGR(NGRUP,MGLAYR,MGSTOR),
     5 NXLRGR(NGRUP,MGLAYR,MGSTOR),NXHTGR(NGRUP,MGLAYR,MGSTOR),
     6 LNHTGR(NGRUP,MGLAYR,MGSTOR),NGAPGR(NGRUP,MGLAYR,MGSTOR),
     7 REDUCD(NGRUP,MGLAYR,MGSTOR),
     8 SAMEAS(NGRUP,MGLAYR,MGSTOR),
     9 STRGHT(NGRUP,MGLAYR,MGSTOR),PRIMHT(NGRUP,MGLAYR,MGSTOR),
     X ISOHGR(NGRUP,MGLAYR,MGSTOR),
     1 LYRUSE(MLTFX),              HITUSE(MHTFX),
     2 GRPSTA(NGRUP,MGLAYR,MGSTOR),HITSTA(NGRUP,MGLAYR,MGSTOR)

      COMMON/CRTFXS/
     1 EFFTOT(NGRUP),
     1 MISHTG(NGRUP,MGLAYR,MGSTOR),MISSTG(NGRUP,MGLAYR,MGSTOR),
     2 STRMNR(NGRUP,MGLAYR,MGSTOR),STRMXR(NGRUP,MGLAYR,MGSTOR)

      REAL ARGSTR
      COMMON/CRTFXD/
     1 ARGSTR(10)

      COMMON/TFXF_T_C/TRACER(M_TRACER_LINES,MHTFX)
      COMMON/TFXF_T_I/N_TRACER(MHTFX),N_HIT_TFXF,HIT_DISPLA
      COMMON/TFXF_T_I_MORE/TRACER_NUM(2,M_TRACER_LINES,MHTFX)

      SAVE /CITFXF/,/CRTFXF/,/CLTFXF/,/CITFXS/
      SAVE /CRTFXS/,/CRTFXD/      









