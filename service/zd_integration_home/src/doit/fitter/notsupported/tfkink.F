*
* $Id: tfkink.F,v 1.1 2003/03/05 17:44:47 dpp Exp $
*
* $Log: tfkink.F,v $
* Revision 1.1  2003/03/05 17:44:47  dpp
*      -> NEW ROUTINE, moved from "fitter/."
*      -> changed all variable names in cdscrtcd to have common root
*
* Revision 1.2  1998/07/09 00:39:17  lyon
* seq/cdgeom -> cl3seq/cdgm3
*
* Revision 1.1.1.1  1998/02/06 19:11:43  dpp
* DOIT first release.
*
* Revision 1.1.1.1  1997/04/30 12:31:28  clib
* Developmental version of DUET.
*
* Revision 1.1.1.1  1994/10/08 01:00:49  zfiles
* first version of doit in CVS
*
*
#include "sys/CLEO_machine.h"
#include "pilot.h"
*CMZ :  6.00/16 08/03/94  13.25.47  by  Rob Kutschke
*CMZ :  6.00/07 31/08/93  14.10.56  by  Rob Kutschke
*CMZ :  5.54/15 07/10/92  11.01.35  by  Dan Peterson
*-- Author :
#if !defined(CLEO_KINKDIAG)
      SUBROUTINE TFKINK(RADKNK,RESKNK)
#endif
#if defined(CLEO_KINKDIAG)
      SUBROUTINE TFKINK
     +(RADKNK,RESKNK,ANGKNK,SUMWT,SUMWTA,RADKN2,RESKN2,RESRAN)
#endif
C
C=======================================================================
C     AUTHOR   D. PETERSON        1992
C
C     TFKINK compares the pattern of residuals in the drift chamber
C         to the patterns that would be ofserved with a kink at
C         some specified radius. Returned are the radius of the
C         best possible kink and the weighted sum of the residuals.
C         The track residuals are also compared to random weights
C         to investigate the accidental probability of identifying
C         a kink.
C
C=======================================================================
      IMPLICIT NONE
      SAVE
#include "doit/duseq/tfindpar.inc"
#include "doit/duseq/tfctlcde.inc"
#include "doit/duseq/tfgeomcd.inc"
#include "doit/duseq/tftrakcd.inc"
#include "cl3seq/cdgm3/cdgeomcd.inc"
C
      REAL RADKNK,RESKNK,ANGKNK,SUMWT,SUMWTA,RADKN2,RESKN2,RESRAN(20)
      REAL RESSUM,RESUMR,SUMWT1,SUMWT2,SUMWT3
      REAL ABS
      INTEGER J,IRAD,IFIT,ILYRS,ILYR,ILYR1,ILYRDR
      INTEGER NUSED,NFBEFR,NFAFTR
      INTEGER IABS
      LOGICAL LFIRSTK/.TRUE./
      REAL RK(20),AVTOAN(20),FACTK(40,20),FACTR(40,20)
C
      DATA RK                  / 0.3250, 0.3500, 0.3750, 0.4000, 0.4250,
     +                           0.4500, 0.4750, 0.5000, 0.5250, 0.5500,
     +                           0.5750, 0.6000, 0.6250, 0.6500, 0.6750,
     +                           0.7000, 0.7250, 0.7500, 0.7750, 0.8000/
      DATA AVTOAN              /60.5481,56.7646,53.7202,54.0781,55.4036,
     +                          58.8080,64.3366,69.3367,76.1282,75.8768,
     +                          76.4299,69.7977,64.7020,59.0734,55.5369,
     +                          54.0430,53.3952,56.0050,58.9650,67.9723/
      DATA (FACTK(J, 1),J=1,40)/-2.4757,-1.9893,-1.4911,-0.4635, 0.0659,
     +                           0.6107, 1.7312, 2.2826, 2.0202, 1.5323,
     +                           1.3065, 1.0907, 0.6969, 0.5161, 0.3481,
     +                           0.0457,-0.0885,-0.2102,-0.4197,-0.5073,
     +                          -0.5827,-0.6994,-0.7404,-0.7695,-0.7933,
     +                          -0.7878,-0.7706,-0.7014,-0.6497,-0.5859,
     +                          -0.4238,-0.3258,-0.2154,-0.0942, 0.0395,
     +                           0.3409, 0.5084, 0.6887, 0.8793, 1.0814/
      DATA (FACTK(J, 2),J=1,40)/-2.1324,-1.7788,-1.4112,-0.6369,-0.2303,
     +                           0.1932, 1.0789, 1.5409, 2.0203, 2.0183,
     +                           1.7411, 1.4759, 0.9909, 0.7676, 0.5597,
     +                           0.1842, 0.0168,-0.1356,-0.3998,-0.5113,
     +                          -0.6083,-0.7610,-0.8167,-0.8582,-0.8996,
     +                          -0.8995,-0.8854,-0.8155,-0.7599,-0.6899,
     +                          -0.5086,-0.3975,-0.2717,-0.1329, 0.0209,
     +                           0.3692, 0.5635, 0.7732, 0.9952, 1.2311/
      DATA (FACTK(J, 3),J=1,40)/-1.7648,-1.5286,-1.2762,-0.7252,-0.4267,
     +                          -0.1100, 0.5692, 0.9315, 1.3125, 2.1199,
     +                           2.1915, 1.8794, 1.3073, 1.0433, 0.7972,
     +                           0.3511, 0.1515,-0.0308,-0.3487,-0.4841,
     +                          -0.6025,-0.7922,-0.8633,-0.9179,-0.9794,
     +                          -0.9861,-0.9769,-0.9102,-0.8531,-0.7795,
     +                          -0.5848,-0.4638,-0.3259,-0.1730,-0.0029,
     +                           0.3841, 0.6008, 0.8352, 1.0839, 1.3485/
      DATA (FACTK(J, 4),J=1,40)/-1.4288,-1.2883,-1.1288,-0.7546,-0.5401,
     +                          -0.3051, 0.2195, 0.5090, 0.8194, 1.4945,
     +                           1.8589, 2.2447, 1.7855, 1.4654, 1.1663,
     +                           0.6223, 0.3777, 0.1535,-0.2401,-0.4092,
     +                          -0.5585,-0.8017,-0.8953,-0.9696,-1.0624,
     +                          -1.0806,-1.0800,-1.0224,-0.9656,-0.8896,
     +                          -0.6815,-0.5498,-0.3983,-0.2291,-0.0399,
     +                           0.3938, 0.6379, 0.9026, 1.1842, 1.4844/
      DATA (FACTK(J, 5),J=1,40)/-1.0567,-1.0096,-0.9404,-0.7372,-0.6033,
     +                          -0.4467,-0.0690, 0.1517, 0.3959, 0.9480,
     +                           1.2557, 1.5873, 2.3111, 1.9992, 1.6398,
     +                           0.9836, 0.6871, 0.4146,-0.0672,-0.2761,
     +                          -0.4618,-0.7692,-0.8905,-0.9893,-1.1223,
     +                          -1.1559,-1.1680,-1.1265,-1.0733,-0.9978,
     +                          -0.7819,-0.6418,-0.4788,-0.2953,-0.0885,
     +                           0.3890, 0.6595, 0.9537, 1.2677, 1.6032/
      DATA (FACTK(J, 6),J=1,40)/-0.6633,-0.7082,-0.7276,-0.6897,-0.6329,
     +                          -0.5501,-0.3087,-0.1504, 0.0345, 0.4795,
     +                           0.7391, 1.0262, 1.6722, 2.0358, 2.3163,
     +                           1.5155, 1.1520, 0.8165, 0.2193,-0.0421,
     +                          -0.2762,-0.6699,-0.8291,-0.9618,-1.1519,
     +                          -1.2086,-1.2402,-1.2268,-1.1821,-1.1116,
     +                          -0.8946,-0.7485,-0.5759,-0.3791,-0.1553,
     +                           0.3670, 0.6652, 0.9911, 1.3400, 1.7142/
      DATA (FACTK(J, 7),J=1,40)/-0.2162,-0.3592,-0.4720,-0.6072,-0.6300,
     +                          -0.6230,-0.5193,-0.4230,-0.2961, 0.0464,
     +                           0.2617, 0.5084, 1.0876, 1.4241, 1.7880,
     +                           2.2927, 1.8419, 1.4242, 0.6751, 0.3442,
     +                           0.0454,-0.4648,-0.6758,-0.8555,-1.1269,
     +                          -1.2175,-1.2788,-1.3112,-1.2828,-1.2242,
     +                          -1.0178,-0.8703,-0.6919,-0.4850,-0.2466,
     +                           0.3182, 0.6441, 1.0023, 1.3878, 1.8029/
      DATA (FACTK(J, 8),J=1,40)/ 0.2942, 0.0501,-0.1598,-0.4765,-0.5837,
     +                          -0.6576,-0.7033,-0.6755,-0.6135,-0.3881,
     +                          -0.2253,-0.0273, 0.4670, 0.7668, 1.0983,
     +                           1.8651, 2.3009, 2.2127, 1.3021, 0.8963,
     +                           0.5271,-0.1125,-0.3824,-0.6166,-0.9852,
     +                          -1.1183,-1.2183,-1.3159,-1.3140,-1.2780,
     +                          -1.1047,-0.9677,-0.7958,-0.5913,-0.3514,
     +                           0.2284, 0.5679, 0.9438, 1.3507, 1.7913/
      DATA (FACTK(J, 9),J=1,40)/ 0.8478, 0.5001, 0.1909,-0.3106,-0.5033,
     +                          -0.6591,-0.8548,-0.8952,-0.8976,-0.7875,
     +                          -0.6756,-0.5245,-0.1104, 0.1556, 0.4578,
     +                           1.1789, 1.5983, 2.0529, 2.2347, 1.7342,
     +                           1.2753, 0.4687, 0.1216,-0.1850,-0.6857,
     +                          -0.8782,-1.0336,-1.2286,-1.2687,-1.2708,
     +                          -1.1600,-1.0478,-0.8964,-0.7079,-0.4798,
     +                           0.0896, 0.4304, 0.8119, 1.2288, 1.6837/
      DATA (FACTK(J,10),J=1,40)/ 1.3255, 0.9105, 0.5345,-0.0987,-0.3565,
     +                          -0.5773,-0.9013,-1.0050,-1.0707,-1.0854,
     +                          -1.0350,-0.9455,-0.6522,-0.4464,-0.2036,
     +                           0.3997, 0.7606, 1.1576, 2.0701, 2.5711,
     +                           2.0598, 1.1494, 0.7509, 0.3937,-0.2074,
     +                          -0.4491,-0.6538,-0.9457,-1.0333,-1.0829,
     +                          -1.0654,-0.9990,-0.8933,-0.7499,-0.5666,
     +                          -0.0853, 0.2122, 0.5507, 0.9252, 1.3382/
      DATA (FACTK(J,11),J=1,40)/ 1.7065, 1.2447, 0.8216, 0.0941,-0.2109,
     +                          -0.4794,-0.8990,-1.0506,-1.1646,-1.2763,
     +                          -1.2745,-1.2340,-1.0387,-0.8825,-0.6891,
     +                          -0.1855, 0.1252, 0.4721, 1.2836, 1.7488,
     +                           2.2491, 2.0463, 1.5883, 1.1720, 0.4517,
     +                           0.1502,-0.1147,-0.5271,-0.6752,-0.7856,
     +                          -0.8901,-0.8847,-0.8407,-0.7586,-0.6373,
     +                          -0.2799,-0.0444, 0.2314, 0.5436, 0.8941/
      DATA (FACTK(J,12),J=1,40)/ 1.8426, 1.3918, 0.9756, 0.2490,-0.0617,
     +                          -0.3403,-0.7924,-0.9664,-1.1073,-1.2849,
     +                          -1.3223,-1.3254,-1.2292,-1.1293,-0.9958,
     +                          -0.6251,-0.3874,-0.1172, 0.5279, 0.9033,
     +                           1.3102, 2.2298, 2.2962, 1.8627, 1.0953,
     +                           0.7642, 0.4652,-0.0278,-0.2221,-0.3835,
     +                          -0.6020,-0.6596,-0.6833,-0.6726,-0.6273,
     +                          -0.4342,-0.2868,-0.1038, 0.1120, 0.3618/
      DATA (FACTK(J,13),J=1,40)/ 1.8700, 1.4436, 1.0477, 0.3499, 0.0474,
     +                          -0.2268,-0.6822,-0.8638,-1.0164,-1.2293,
     +                          -1.2902,-1.3210,-1.2918,-1.2316,-1.1415,
     +                          -0.8700,-0.6881,-0.4773, 0.0367, 0.3403,
     +                           0.6719, 1.4284, 1.8536, 2.3061, 1.7845,
     +                           1.4216, 1.0865, 0.5097, 0.2676, 0.0542,
     +                          -0.2801,-0.4014,-0.4932,-0.5541,-0.5851,
     +                          -0.5557,-0.4958,-0.4051,-0.2848,-0.1344/
      DATA (FACTK(J,14),J=1,40)/ 1.7888, 1.4033, 1.0438, 0.4051, 0.1256,
     +                          -0.1300,-0.5617,-0.7381,-0.8898,-1.1144,
     +                          -1.1877,-1.2356,-1.2533,-1.2233,-1.1678,
     +                          -0.9787,-0.8448,-0.6862,-0.2901,-0.0523,
     +                           0.2095, 0.8126, 1.1542, 1.5192, 2.3293,
     +                           2.0331, 1.6716, 1.0287, 0.7471, 0.4894,
     +                           0.0536,-0.1249,-0.2787,-0.4056,-0.5075,
     +                          -0.6328,-0.6566,-0.6546,-0.6268,-0.5733/
      DATA (FACTK(J,15),J=1,40)/ 1.6800, 1.3336, 1.0095, 0.4303, 0.1749,
     +                          -0.0600,-0.4616,-0.6285,-0.7744,-0.9984,
     +                          -1.0768,-1.1335,-1.1799,-1.1699,-1.1378,
     +                          -1.0069,-0.9078,-0.7873,-0.4788,-0.2905,
     +                          -0.0815, 0.4046, 0.6819, 0.9795, 1.6431,
     +                           2.0069, 2.3067, 1.5874, 1.2622, 0.9569,
     +                           0.4151, 0.1784,-0.0378,-0.2303,-0.4019,
     +                          -0.6773,-0.7813,-0.8638,-0.9236,-0.9614/
      DATA (FACTK(J,16),J=1,40)/ 1.5601, 1.2497, 0.9587, 0.4362, 0.2045,
     +                          -0.0097,-0.3790,-0.5344,-0.6717,-0.8879,
     +                          -0.9669,-1.0274,-1.0902,-1.0931,-1.0768,
     +                          -0.9869,-0.9129,-0.8203,-0.5771,-0.4262,
     +                          -0.2573, 0.1390, 0.3668, 0.6120, 1.1615,
     +                           1.4639, 1.7877, 2.2364, 1.8585, 1.4971,
     +                           0.8345, 0.5329, 0.2484,-0.0150,-0.2611,
     +                          -0.6940,-0.8811,-1.0503,-1.1992,-1.3291/
      DATA (FACTK(J,17),J=1,40)/ 1.4187, 1.1455, 0.8886, 0.4256, 0.2192,
     +                           0.0278,-0.3049,-0.4464,-0.5725,-0.7748,
     +                          -0.8513,-0.9120,-0.9840,-0.9957,-0.9911,
     +                          -0.9331,-0.8794,-0.8099,-0.6216,-0.5025,
     +                          -0.3681,-0.0495, 0.1350, 0.3343, 0.7833,
     +                           1.0313, 1.2974, 1.8767, 2.1896, 2.1046,
     +                           1.3138, 0.9441, 0.5881, 0.2509,-0.0724,
     +                          -0.6678,-0.9401,-1.1980,-1.4378,-1.6615/
      DATA (FACTK(J,18),J=1,40)/ 1.2941, 1.0511, 0.8224, 0.4088, 0.2238,
     +                           0.0516,-0.2492,-0.3780,-0.4936,-0.6817,
     +                          -0.7543,-0.8134,-0.8885,-0.9052,-0.9077,
     +                          -0.8704,-0.8305,-0.7768,-0.6269,-0.5304,
     +                          -0.4205,-0.1578,-0.0048, 0.1613, 0.5367,
     +                           0.7448, 0.9685, 1.4567, 1.7210, 2.0013,
     +                           1.9918, 1.5282, 1.0754, 0.6398, 0.2153,
     +                          -0.5884,-0.9678,-1.3357,-1.6870,-2.0243/
      DATA (FACTK(J,19),J=1,40)/ 1.1310, 0.9244, 0.7295, 0.3760, 0.2173,
     +                           0.0691,-0.1913,-0.3036,-0.4051,-0.5723,
     +                          -0.6383,-0.6930,-0.7670,-0.7867,-0.7947,
     +                          -0.7759,-0.7489,-0.7105,-0.5986,-0.5249,
     +                          -0.4401,-0.2351,-0.1146, 0.0165, 0.3147,
     +                           0.4806, 0.6594, 1.0507, 1.2630, 1.4885,
     +                           1.9729, 2.2316, 1.6783, 1.1347, 0.5989,
     +                          -0.4339,-0.9311,-1.4202,-1.8943,-2.3567/
      DATA (FACTK(J,20),J=1,40)/ 0.9958, 0.8177, 0.6494, 0.3435, 0.2057,
     +                           0.0769,-0.1505,-0.2492,-0.3387,-0.4876,
     +                          -0.5471,-0.5973,-0.6675,-0.6881,-0.6988,
     +                          -0.6908,-0.6720,-0.6436,-0.5572,-0.4990,
     +                          -0.4315,-0.2665,-0.1689,-0.0623, 0.1811,
     +                           0.3171, 0.4638, 0.7858, 0.9608, 1.1470,
     +                           1.5474, 1.7616, 1.9871, 2.0169, 1.3037,
     +                          -0.0881,-0.7669,-1.4407,-2.0999,-2.7494/
      DATA (FACTR(J, 1),J=1,40)/ 1.0467,-1.3813, 1.2931,-0.3642, 1.0356,
     +                           1.5650,-0.2546,-1.2455, 1.1796,-0.9789,
     +                          -0.1058, 0.1900,-1.2834,-0.7964, 0.6493,
     +                           1.2247,-1.5382,-0.3747,-0.1925, 1.3458,
     +                           1.2966, 0.0255, 1.6301,-0.1014,-0.6847,
     +                          -1.4212,-1.1451,-0.9578,-0.8858, 0.6756,
     +                           0.9687, 1.3748, 0.9626, 0.1312, 0.0275,
     +                          -1.4585, 0.4735, 0.3074, 1.3965,-0.7889/
      DATA (FACTR(J, 2),J=1,40)/-0.5082, 0.3135, 0.3121,-1.1031,-0.6659,
     +                          -0.3439, 0.2149,-0.3080, 0.8754,-0.7066,
     +                          -0.7551, 1.5886, 1.6599,-0.6257,-0.8103,
     +                          -1.8809,-1.4000,-0.2483, 0.5238,-1.5334,
     +                           0.5633, 0.9273, 0.4530,-0.0409,-1.7657,
     +                          -0.4992, 0.5348,-1.6864,-1.2893,-1.1456,
     +                          -0.1922, 1.0830,-0.2566,-1.3845,-1.0720,
     +                          -1.6820,-0.3576,-1.1222,-1.1324, 0.7636/
      DATA (FACTR(J, 3),J=1,40)/ 1.4551, 1.5964, 0.5479, 0.4332, 1.7030,
     +                           0.6410, 0.7658,-1.2972, 0.2681, 0.5874,
     +                           1.3877, 0.3638,-0.1272,-0.8815, 1.4716,
     +                           1.4442,-0.0544, 0.8576, 0.2579, 1.5827,
     +                          -1.1013,-1.2976,-0.9852, 0.6084,-1.3172,
     +                          -0.7768, 0.7951,-0.5289,-1.3726, 1.6285,
     +                           0.2240,-1.5031,-0.3515,-0.0740,-0.2686,
     +                          -0.4295,-0.9787,-0.4485, 0.0590,-1.5984/
      DATA (FACTR(J, 4),J=1,40)/ 0.2082,-1.1730, 1.4814, 0.7482, 0.8940,
     +                           1.6571, 0.8716, 0.9769, 0.7295, 0.9688,
     +                           1.0687, 1.2997,-1.1423, 0.4179, 0.0539,
     +                          -0.3569,-1.1387,-0.6410, 0.5767, 0.8738,
     +                           1.0752, 1.6810, 0.9416,-0.7115, 0.2568,
     +                           1.4091, 0.5914, 1.5609,-0.3207,-1.3255,
     +                          -1.4289,-0.3433, 0.6374,-1.0400, 1.1450,
     +                           1.1310,-0.7375, 0.6156,-0.7071,-1.4555/
      DATA (FACTR(J, 5),J=1,40)/ 1.5899,-0.0587,-1.5522,-0.6493,-0.5737,
     +                           1.3314, 1.2257, 1.0248,-1.4188, 0.1033,
     +                           0.7888,-0.3215, 0.4604,-0.2608,-1.1805,
     +                           0.4725, 0.2608,-0.8022, 0.5899, 0.2703,
     +                          -1.2699, 0.3763,-1.4517,-0.5563,-0.8242,
     +                          -1.5411, 1.4112, 0.8914,-0.0135,-1.5934,
     +                           1.5307,-0.7124,-0.6381, 1.0563,-1.3705,
     +                          -1.0138,-0.0198,-1.1366,-1.5734,-0.7789/
      DATA (FACTR(J, 6),J=1,40)/ 1.4806,-1.3444, 1.3819, 1.2476,-0.4166,
     +                          -0.3054,-1.2417, 1.0366,-0.9742,-0.1788,
     +                           1.5132, 1.5933, 0.0531,-0.0676,-1.0845,
     +                          -0.5599,-0.9924, 1.0600, 0.9382, 1.2392,
     +                           0.0450, 0.2198,-0.4159,-0.8275,-0.7616,
     +                           0.8025,-1.6718, 1.5081,-0.9336,-0.3381,
     +                           1.0708,-0.1092, 0.2139,-0.9546,-1.1068,
     +                          -1.4634, 0.0214,-1.6433, 0.0740, 1.2019/
      DATA (FACTR(J, 7),J=1,40)/-1.6429,-0.4105,-1.5595,-1.2250, 0.1066,
     +                          -0.7920, 0.0647,-0.2598,-0.7075, 0.4492,
     +                           1.6751, 0.8325,-1.1609, 1.2980,-0.6604,
     +                          -0.3928,-0.7004,-1.6436,-1.2177,-0.5745,
     +                           1.0057, 0.7173,-0.5956, 0.4849, 0.0398,
     +                           1.4704, 1.5231, 0.2134,-1.1081,-0.6539,
     +                          -1.3101,-0.5547,-1.2814, 1.1710, 1.2341,
     +                           0.6823, 0.8070,-0.1332,-1.0518, 1.5996/
      DATA (FACTR(J, 8),J=1,40)/ 1.1603, 0.3059, 0.1062, 0.5062, 1.6521,
     +                          -0.1844, 0.7920,-0.4182,-0.5945,-0.0979,
     +                           1.2346, 0.6613,-1.5437,-1.8083, 1.3496,
     +                          -0.3479, 1.8043,-0.9687, 0.5591,-1.4045,
     +                          -1.0400,-1.3288, 1.8788,-0.8551,-0.2979,
     +                           0.4098,-0.2573, 0.4674,-0.3489,-0.0134,
     +                           0.2480, 1.3255, 1.1668, 0.4575,-0.2833,
     +                          -1.5721,-1.8031, 0.6747, 0.9534,-0.0070/
      DATA (FACTR(J, 9),J=1,40)/-1.1489, 1.1159, 0.6827, 0.5027, 0.8580,
     +                          -0.8450, 1.1514, 1.1288, 1.0988,-1.2904,
     +                           1.4910,-1.3203,-0.9675,-0.1136,-0.3168,
     +                          -1.4083,-0.0680,-0.5315, 1.5322,-0.6377,
     +                          -0.0026, 0.8156,-1.0290,-0.6100,-1.6076,
     +                           0.5887, 1.5353,-1.1940,-0.5624, 1.3863,
     +                           0.9368,-0.5133,-1.1995, 0.7799, 0.2791,
     +                          -0.3659,-1.4808,-0.9640, 1.4489,-0.2884/
      DATA (FACTR(J,10),J=1,40)/ 0.5571,-0.2091, 0.6975,-0.9820,-0.5524,
     +                          -1.6580, 1.1498, 0.4731, 0.1539, 0.6949,
     +                           1.2147, 0.4923, 0.5935,-0.0199, 1.2263,
     +                          -1.4392, 1.4895, 0.3821, 0.1926,-0.8686,
     +                          -0.3352,-0.2430,-0.6843,-1.8085,-0.4124,
     +                           1.0331,-0.1549,-0.0775,-1.8129, 0.7490,
     +                           1.6901,-1.5238, 0.7723,-1.7175, 1.6001,
     +                           0.7933, 0.2249, 0.7807, 1.1479,-1.1702/
      DATA (FACTR(J,11),J=1,40)/ 0.1369,-1.1140, 0.4437, 1.2909,-1.0178,
     +                          -1.7592,-0.4883,-0.3202, 0.0102,-1.0715,
     +                           1.2655,-0.4905, 0.0623,-0.0451,-1.4050,
     +                          -1.6087, 0.6171,-0.0541, 0.0482, 1.4894,
     +                          -0.6800,-0.3449, 1.4467,-0.8338, 1.5691,
     +                           0.6982, 1.3364,-1.3061,-0.2587,-1.4769,
     +                          -0.9935, 0.1027,-1.4249,-0.5259,-1.2572,
     +                           0.8809,-1.0974,-0.2002, 1.5150, 0.9914/
      DATA (FACTR(J,12),J=1,40)/ 0.5264,-1.0147, 0.6522, 0.8612, 0.3165,
     +                          -0.9243,-1.5728,-0.4478,-0.1290,-0.5439,
     +                          -1.2966,-1.1249,-0.7348, 1.6174,-1.5919,
     +                           0.7542,-1.6570,-1.3669, 1.5806, 0.2282,
     +                          -0.8554, 1.1071,-1.4869, 1.0352, 0.0889,
     +                           0.3962,-0.5387,-0.1705,-0.6818, 1.4535,
     +                           1.0695,-0.7766, 1.1241,-0.7617,-1.4427,
     +                          -0.8911,-0.7633, 0.8362,-1.0050,-0.3941/
      DATA (FACTR(J,13),J=1,40)/ 1.2306, 0.7154, 0.9539,-1.2163, 1.4986,
     +                          -1.4497, 0.5635, 0.7084,-0.8556, 1.1345,
     +                           0.9170, 0.0459, 1.4747, 0.0499, 0.0101,
     +                           0.4350, 0.9784,-0.4242,-0.4249, 0.2133,
     +                           1.2974, 0.0790, 0.0592,-0.4625,-0.8868,
     +                          -1.4141,-0.9624,-1.4836, 1.1188,-1.2104,
     +                           1.1889, 1.2846, 1.0646,-1.4385,-0.4142,
     +                          -1.3810,-0.9322,-1.3878,-0.0884, 1.4633/
      DATA (FACTR(J,14),J=1,40)/ 0.3201, 0.4421,-1.2062, 1.4611,-0.6608,
     +                           0.5398, 1.5671,-1.4932, 0.6265, 1.3988,
     +                           0.1518,-1.2410,-1.1872,-1.0297, 0.7354,
     +                           1.5316, 0.4643,-1.7233,-0.3124, 0.8389,
     +                          -0.3877,-0.8934, 0.2876,-0.8547, 1.1734,
     +                          -0.0676, 0.6741, 0.9460,-0.7348, 0.0138,
     +                          -1.2764, 0.3686, 1.1620, 1.2614,-1.6769,
     +                          -1.4059, 0.2904, 0.6293, 1.4982, 0.4365/
      DATA (FACTR(J,15),J=1,40)/-0.1779,-0.1652,-0.3105, 0.6523, 1.0336,
     +                           1.5111,-0.9455,-0.5314, 0.5175, 0.7980,
     +                          -0.5785,-0.0189, 0.1144,-1.3468, 1.4808,
     +                          -1.4083,-1.6161,-0.6162, 1.4407,-0.1608,
     +                          -0.2704, 1.0883, 0.5879,-1.2223,-0.6868,
     +                          -1.7358, 0.2726, 1.5445, 1.1214, 1.6776,
     +                          -1.0723,-1.1477,-1.0228,-0.9143, 0.6470,
     +                          -1.5107,-0.8812, 0.1050,-1.2223,-0.3315/
      DATA (FACTR(J,16),J=1,40)/-0.0407, 0.2642, 0.8691, 1.3221, 0.6997,
     +                           0.2238, 1.0390, 0.3635,-0.3671, 0.8824,
     +                          -0.7094, 1.0508,-0.5066,-0.8790,-1.3430,
     +                           0.5991,-1.5813,-0.0291,-1.4583, 0.5325,
     +                           1.0210, 1.5044, 0.8989,-1.5907, 0.8480,
     +                          -0.4992,-1.0171, 0.7373, 0.8035, 1.3487,
     +                           0.8455,-0.7545,-1.7253, 1.6353,-0.0666,
     +                           0.7307, 1.5373,-0.6413,-1.5757,-0.8152/
      DATA (FACTR(J,17),J=1,40)/ 0.0619, 0.8534,-0.2007, 0.8502, 0.5165,
     +                          -1.0168, 1.7712, 0.0539,-1.7303, 0.4485,
     +                          -0.7810, 1.3296, 1.0235, 0.3886, 0.3766,
     +                          -0.9511,-0.4647, 1.5130,-1.0316,-0.7350,
     +                           1.6271, 0.2245,-0.6825, 0.8537,-1.6931,
     +                          -1.7011, 1.0263,-0.1241, 1.4185,-1.0141,
     +                          -0.9581,-0.8475, 0.5077,-0.2392, 1.5511,
     +                           1.4809,-0.3344, 1.0721, 0.5559, 0.5045/
      DATA (FACTR(J,18),J=1,40)/-0.1756, 0.6307, 0.7585, 1.0438,-1.6826,
     +                          -0.3664,-1.1795, 0.9829,-0.6374, 1.3768,
     +                           1.1895,-1.2775, 0.2101,-0.3094, 0.2656,
     +                           0.9884, 0.4165,-1.1885, 1.6136,-1.7210,
     +                          -1.1271, 1.1933, 0.0068, 1.5336, 0.9130,
     +                           0.9439, 0.6255,-0.9525, 0.0868,-1.0983,
     +                           1.2750,-0.5716, 0.2409, 1.2329,-0.5413,
     +                           1.5665,-0.8184,-0.4841, 1.5233,-0.3339/
      DATA (FACTR(J,19),J=1,40)/-0.4631,-1.2023, 0.2807, 1.5405, 0.7862,
     +                           1.8966,-0.7607, 1.7245, 1.2805, 0.0593,
     +                          -0.1182, 0.4898, 1.4130, 1.1125, 0.0977,
     +                          -1.1983, 0.0077, 0.5022, 0.8061,-1.5812,
     +                           0.1963,-0.0659,-0.0725,-0.5025,-1.1972,
     +                          -0.8881,-0.7498,-0.7470, 1.8280, 0.3094,
     +                           0.1577,-0.9484,-1.7825, 0.7920,-1.5520,
     +                           0.6631,-0.7684, 1.4047,-0.0996,-0.9542/
      DATA (FACTR(J,20),J=1,40)/-0.4712,-1.0973,-1.4729, 1.6263, 0.8752,
     +                           0.4533,-1.3617,-0.4120,-0.8816, 1.2695,
     +                          -0.6725,-0.7024, 0.7485, 0.6074, 0.3898,
     +                           1.3506, 1.0524,-1.5483, 1.1798,-0.5522,
     +                          -0.6030,-1.4691, 1.3370, 1.1572,-0.1022,
     +                          -0.7708,-0.9087, 1.6302, 1.3666, 0.0603,
     +                          -0.7612,-1.4008, 0.1059,-1.0936, 0.2523,
     +                          -0.7315,-0.3924, 1.1306,-1.1499,-0.7830/
C
C executable
      IF(.NOT.LFIRSTK)GO TO 5
      LFIRSTK=.FALSE.
      PRINT 1001
1001  FORMAT(' TFKINK: VERSION 3')
5     CONTINUE
C
C test if valid data is in TFTRAKCD
C
      IF(NFIT.LE.0)GO TO 995
C
C TF layer number of the first DR anode layer
C
      ILYR1=ILCDTF(ILDVCD(1,IDRFT))
C
C loop over possible radii
C
      RESKNK=0.
      RADKNK=9.0
      DO 39 IRAD=1,20
C
C get weighted sum of residuals for this radius
C
      RESSUM=0.
      SUMWT1=0.
      SUMWT2=0.
#if defined(CLEO_KINKDIAG)
      RESUMR=0.
      SUMWT3=0.
#endif
      NUSED=0
      NFBEFR=0
      NFAFTR=0
      DO 29 IFIT=1,NFIT
      ILYRS=IPLFIT(IFIT)
C TF layer number
      ILYR=IABS(ILYRS)
C require hit to be in DR
      IF(ILYR .GT. QDIVAD ) GOTO 29
      IF(IDVCTF(ILYR).NE.IDRFT)GO TO 29
C DR local axial wire number, require DR axial
      ILYRDR=ILYR-ILYR1+1
      IF(ILYRDR.LT.1)GO TO 29
      IF(ILYRDR.GT.40)GO TO 29
C count fitted hits before and after the kink, in the DR
      IF((ILYRS.GT.0).AND.(RTF(ILYR).LT.RK(IRAD)))NFBEFR=NFBEFR+1
      IF((ILYRS.GT.0).AND.(RTF(ILYR).GT.RK(IRAD)))NFAFTR=NFAFTR+1
C cut of 1500 um as in CBX 87-54
      IF(ABS(PULFIT(IFIT)).GT. 0.001500)GO TO 29
C add in the weighted residual
      NUSED=NUSED+1
      RESSUM=RESSUM+    FACTK(ILYRDR,IRAD) *PULFIT(IFIT)
      SUMWT1=SUMWT1+    FACTK(ILYRDR,IRAD)
      SUMWT2=SUMWT2+ABS(FACTK(ILYRDR,IRAD))
#if defined(CLEO_KINKDIAG)
      RESUMR=RESUMR+    FACTR(ILYRDR,IRAD) *PULFIT(IFIT)
      SUMWT3=SUMWT3+ABS(FACTR(ILYRDR,IRAD))
#endif
29    CONTINUE
C
C require 25 axial hits in the DR
C
      IF(NUSED.LT.25)GO TO 993
C
C require hits in the DR before and after the kink
C
      IF(NFBEFR.LT.3)GO TO 39
      IF(NFAFTR.LT.3)GO TO 39

C compare to the best values for a kink
C
      IF(ABS(RESSUM).LT.ABS(RESKNK))GO TO 31
      RESKNK=RESSUM
      RADKNK=RK(IRAD)
      ANGKNK= -AVTOAN(IRAD)*RESKNK/NUSED
      SUMWT =SUMWT1
      SUMWTA=SUMWT2
31    CONTINUE
C
#if defined(CLEO_KINKDIAG)
C compare to the best randum values
C RESRAN(NRAN) is the greatest sum of resolutions out of NRAN tries
C RESRAN(20) will be tested for all IRAD
C RESRAN(1) will be tested only for IRAD=1
C
      IF(IRAD.GT.1)GO TO 34
      RESRAN(1)=0.
      GO TO 35
34    RESRAN(IRAD)=RESRAN(IRAD-1)
35    IF(ABS(RESUMR).LT.ABS(RESRAN(IRAD)))GO TO 37
      RESRAN(IRAD)=RESUMR
37    CONTINUE
#endif
C
39    CONTINUE
C            ^---end loop over kink radius
C
C normalize
C
      RESKNK=RESKNK/NUSED
#if defined(CLEO_KINKDIAG)
      DO 59 IRAD=1,20
59    RESRAN(IRAD)=RESRAN(IRAD)/NUSED
C
C second loop to obtain second best kink point
C
      RESKN2=0.
      DO 79 IRAD=1,20
      IF(ABS(RK(IRAD)-RADKNK).LT. 0.11)GO TO 79
      RESSUM=0.
      SUMWT1=0.
      SUMWT2=0.
      NUSED=0
      DO 69 IFIT=1,NFIT
      ILYRS=IPLFIT(IFIT)
      ILYR=IABS(ILYRS)
      IF(IDVCTF(ILYR).NE.IDRFT)GO TO 69
      ILYRDR=ILYR-ILYR1+1
      IF(ILYRDR.LT.1)GO TO 69
      IF(ILYRDR.GT.40)GO TO 69
      IF(ABS(PULFIT(IFIT)).GT. 0.001500)GO TO 69
      NUSED=NUSED+1
      RESSUM=RESSUM+    FACTK(ILYRDR,IRAD) *PULFIT(IFIT)
      SUMWT1=SUMWT1+    FACTK(ILYRDR,IRAD)
      SUMWT2=SUMWT2+ABS(FACTK(ILYRDR,IRAD))
69    CONTINUE
      IF(ABS(RESSUM).LT.ABS(RESKN2))GO TO 71
      RESKN2=RESSUM
      RADKN2=RK(IRAD)
71    CONTINUE
79    CONTINUE
      RESKN2=RESKN2/NUSED
#endif
C
C
      GO TO 997
C
C LESS THAN 25 HITS CONTRIBUTING
993   RESKNK=-2.
      RADKNK=9.1
      GO TO 997
C
C NFIT .LE.0
995   RESKNK=-1.
      RADKNK=9.2
C
997   CONTINUE
      RETURN
      END









